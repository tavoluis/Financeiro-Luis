<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Consórcio</title>
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzQ3NTViZiI+PHBhdGggZD0iTTcuNSw3LjUgVjE2LjUgSDkuNSBWNy40OTk5OSBMNy41LDcuNVoiLz48cGF0aCBkPSJNMTEuNSw3LjUgVjEyLjUgSDEzLjUgVjcuNDk5OTkgTDExLjUsNy41WiIvPjxwYXRoIGQ9Ik0xNS41LDcuNSBWMTQuNSBIMTcuNSBWNy40OTk5OSBMMTUuNSw3LjVoiLz48cGF0aCBkPSJNMjIsMy41MDAwMSBDMjIsMy41MDAwMSAyMiw1IDIwLjUsNSBDMTksNSA4LDUgOCw1IEM2LjMzMzMzLDUgNSw2LjMzMzMzIDUsOCBDNSw4IDUsMTkgNSwxOSBDNSwyMC42NjY3IDYuMzMzMzMsMjIgOCwyMiBDOCwyMiAxOSwyMiAxOSwyMiBDMjAuNjY2NywyMiAyMiwyMC42NjY3IDIyLDE5IEwyMiwzLjUwMDAxIFoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0yIC0xKSIvPjwvc3ZnPg==">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .highlight-contemplado { background-color: #ef4444 !important; color: white !important; font-weight: bold; }
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-6">
             <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Painel de Controle de Consórcio</h1>
                    <p class="text-gray-500 mt-1">Gerencie os participantes e pagamentos de forma fácil e visual.</p>
                </div>
                <div class="mt-4 sm:mt-0">
                    <label for="productName" class="block text-sm font-medium text-gray-700">Produto do Consórcio:</label>
                    <input type="text" id="productName" placeholder="Ex: Videogame, Celular..." class="mt-1 w-full sm:w-64 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
        </header>

        <div id="dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow-md"><h2 class="text-sm font-medium text-gray-500">Total Geral Arrecadado</h2><p id="totalGeral" class="text-2xl font-bold text-gray-800 mt-1">R$ 0,00</p></div>
            <div class="bg-white p-4 rounded-lg shadow-md"><h2 class="text-sm font-medium text-gray-500">Participantes</h2><p id="numParticipantes" class="text-2xl font-bold text-gray-800 mt-1">0</p></div>
            <div class="bg-white p-4 rounded-lg shadow-md"><h2 class="text-sm font-medium text-gray-500">Contemplados</h2><p id="numContemplados" class="text-2xl font-bold text-gray-800 mt-1">0</p></div>
            <div class="bg-white p-4 rounded-lg shadow-md"><h2 class="text-sm font-medium text-gray-500">Total Arrecadado no Mês</h2><div class="flex items-center mt-1"><p id="totalMes" class="text-2xl font-bold text-gray-800 mr-2">R$ 0,00</p><select id="mesReferencia" class="bg-gray-100 border-gray-300 rounded-md text-sm p-1"></select></div></div>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                    <tr>
                        <th scope="col" class="px-4 py-3 min-w-[150px]">Nome do Cliente</th>
                        <th scope="col" class="px-4 py-3 min-w-[120px]">Status</th>
                        <th scope="col" class="px-4 py-3 min-w-[150px]">Mês da Contemplação</th>
                        <th scope="col" class="px-4 py-3 min-w-[120px]">Valor Parcela</th>
                        <th scope="col" class="px-4 py-3 min-w-[150px] text-right">Total Pago (Cliente)</th>
                        <th scope="col" class="px-4 py-3 min-w-[120px] text-center">Ações</th>
                    </tr>
                </thead>
                <tbody id="tabela-corpo"></tbody>
                <tfoot class="font-semibold text-gray-700 bg-gray-100">
                    <tr id="tabela-rodape"></tr>
                </tfoot>
            </table>
        </div>

        <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Adicionar Novo Participante</h3>
            <form id="formAdicionarCliente" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="nomeCliente" class="block text-sm font-medium text-gray-700">Nome do Cliente</label>
                    <input type="text" id="nomeCliente" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="valorParcela" class="block text-sm font-medium text-gray-700">Valor da Parcela (R$)</label>
                    <input type="number" id="valorParcela" required min="0" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex items-end"><button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Adicionar</button></div>
            </form>
        </div>
    </div>
    
    <div id="delete-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-bold text-gray-900">Confirmar Exclusão</h3>
            <p class="mt-2 text-sm text-gray-600">Você tem certeza que deseja excluir este participante? Esta ação não pode ser desfeita.</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Excluir</button>
            </div>
        </div>
    </div>


<script>
    // --- CONFIGURAÇÃO INICIAL ---
    const meses = ["Jan/25", "Fev/25", "Mar/25", "Abr/25", "Mai/25", "Jun/25", "Jul/25", "Ago/25", "Set/25", "Out/25", "Nov/25", "Dez/25"];
    
    // --- ELEMENTOS DO DOM ---
    const productNameInput = document.getElementById('productName');
    const tabelaCorpo = document.getElementById('tabela-corpo');
    const tabelaRodape = document.getElementById('tabela-rodape');
    const formAdicionarCliente = document.getElementById('formAdicionarCliente');
    const mesReferenciaSelect = document.getElementById('mesReferencia');
    const totalGeralEl = document.getElementById('totalGeral');
    const numParticipantesEl = document.getElementById('numParticipantes');
    const numContempladosEl = document.getElementById('numContemplados');
    const totalMesEl = document.getElementById('totalMes');
    const deleteModal = document.getElementById('delete-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    let participantIdToDelete = null;

    // --- DADOS DA APLICAÇÃO ---
    let appData = {
        product: '',
        participants: []
    };

    /**
     * Carrega os dados do localStorage, fazendo a migração do formato antigo se necessário.
     */
    function carregarDados() {
        const rawData = localStorage.getItem('consorcioData');
        if (!rawData) {
            // Se não há dados, usa a estrutura de exemplo
            appData = {
                product: 'Ex: Videogame, Celular',
                participants: [
                    { id: 1, nome: "Ana Silva", valorParcela: 500, status: "Contemplado", mesContemplacao: "Mar/25", pagamentos: {"Jan/25": 500, "Fev/25": 500, "Mar/25": 500} },
                    { id: 2, nome: "Bruno Costa", valorParcela: 500, status: "Ativo", mesContemplacao: "", pagamentos: {"Jan/25": 500, "Fev/25": 500, "Mar/25": 0} },
                ]
            };
            return;
        }

        const parsedData = JSON.parse(rawData);
        
        // **Mecanismo de Migração Automática**
        if (Array.isArray(parsedData)) {
            // Formato antigo detectado (só o array de participantes)
            appData = {
                product: '', // Adiciona o campo de produto
                participants: parsedData
            };
            salvarDados(); // Salva no novo formato imediatamente
        } else {
            // Formato novo já em uso
            appData = parsedData;
        }
    }

    /**
     * Salva o objeto de dados completo no localStorage.
     */
    function salvarDados() {
        localStorage.setItem('consorcioData', JSON.stringify(appData));
    }


    function formatarMoeda(valor) {
        return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function renderizarTabela() {
        tabelaCorpo.innerHTML = '';
        
        appData.participants.forEach(p => {
            const tr = document.createElement('tr');
            tr.className = 'bg-white border-b';
            
            let totalPagoCliente = 0;
            let pagamentosHtml = '';

            meses.forEach(mes => {
                const pago = p.pagamentos[mes] || 0;
                totalPagoCliente += pago;
                const isContempladoNoMes = p.mesContemplacao === mes;
                
                pagamentosHtml += `<td class="px-4 py-2 ${isContempladoNoMes ? 'highlight-contemplado' : ''}"><input type="number" value="${pago}" min="0" data-id="${p.id}" data-mes="${mes}" class="w-24 bg-gray-50 border border-gray-300 rounded-md p-1 text-right focus:outline-none focus:ring-1 focus:ring-blue-500 payment-input"></td>`;
            });

            tr.innerHTML = `
                <td class="px-4 py-2 font-medium text-gray-900">${p.nome}</td>
                <td class="px-4 py-2"><select data-id="${p.id}" class="status-select bg-gray-50 border border-gray-300 rounded-md p-1"><option value="Ativo" ${p.status === 'Ativo' ? 'selected' : ''}>Ativo</option><option value="Contemplado" ${p.status === 'Contemplado' ? 'selected' : ''}>Contemplado</option><option value="Finalizado" ${p.status === 'Finalizado' ? 'selected' : ''}>Finalizado</option></select></td>
                <td class="px-4 py-2"><select data-id="${p.id}" class="mes-contemplacao-select bg-gray-50 border border-gray-300 rounded-md p-1 w-full"><option value="">Nenhum</option>${meses.map(m => `<option value="${m}" ${p.mesContemplacao === m ? 'selected' : ''}>${m}</option>`).join('')}</select></td>
                <td class="px-4 py-2">${formatarMoeda(p.valorParcela)}</td>
                ${pagamentosHtml}
                <td class="px-4 py-2 font-semibold text-right">${formatarMoeda(totalPagoCliente)}</td>
                <td class="px-4 py-2 text-center">
                    <button data-id="${p.id}" class="edit-btn p-1 text-blue-600 hover:text-blue-800" title="Editar Nome">&#9998;</button>
                    <button data-id="${p.id}" class="delete-btn p-1 text-red-600 hover:text-red-800" title="Excluir Participante">&#128465;</button>
                </td>
            `;
            tabelaCorpo.appendChild(tr);
        });
        
        atualizarRodape();
        atualizarDashboard();
        adicionarEventListenersDinamicos();
        salvarDados();
    }
    
    function adicionarEventListenersDinamicos() {
        document.querySelectorAll('.payment-input').forEach(i => i.addEventListener('change', handlePagamentoChange));
        document.querySelectorAll('.status-select').forEach(s => s.addEventListener('change', handleStatusChange));
        document.querySelectorAll('.mes-contemplacao-select').forEach(s => s.addEventListener('change', handleMesContemplacaoChange));
        document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', handleEdit));
        document.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', handleDelete));
    }

    function atualizarRodape() {
        let rodapeHtml = `<td colspan="4" class="px-4 py-3 text-right font-bold">TOTAIS DO MÊS:</td>`;
        let totalGeralFinal = 0;
        
        meses.forEach(mes => {
            const totalMes = appData.participants.reduce((acc, p) => acc + (p.pagamentos[mes] || 0), 0);
            totalGeralFinal += totalMes;
            rodapeHtml += `<td class="px-4 py-3 text-center font-bold">${formatarMoeda(totalMes)}</td>`;
        });
        
        rodapeHtml += `<td class="px-4 py-3 text-right font-bold">${formatarMoeda(totalGeralFinal)}</td><td></td>`;
        tabelaRodape.innerHTML = rodapeHtml;
    }

    function atualizarDashboard() {
        const totalGeral = appData.participants.reduce((acc, p) => acc + Object.values(p.pagamentos).reduce((soma, v) => soma + v, 0), 0);
        const mesSelecionado = mesReferenciaSelect.value;
        const totalMesSelecionado = appData.participants.reduce((acc, p) => acc + (p.pagamentos[mesSelecionado] || 0), 0);

        totalGeralEl.textContent = formatarMoeda(totalGeral);
        numParticipantesEl.textContent = appData.participants.length;
        numContempladosEl.textContent = appData.participants.filter(p => p.status === 'Contemplado' || p.status === 'Finalizado').length;
        totalMesEl.textContent = formatarMoeda(totalMesSelecionado);
        productNameInput.value = appData.product;
    }
    
    function popularCabecalhoEMeses() {
        const headerRow = document.querySelector('thead tr');
        const totalPagoHeader = headerRow.children[headerRow.children.length - 2];
        const acoesHeader = headerRow.lastElementChild;
        headerRow.innerHTML = ''; // Limpa para reconstruir
        
        // Recria os cabeçalhos fixos
        headerRow.innerHTML = `
            <th scope="col" class="px-4 py-3 min-w-[150px]">Nome do Cliente</th>
            <th scope="col" class="px-4 py-3 min-w-[120px]">Status</th>
            <th scope="col" class="px-4 py-3 min-w-[150px]">Mês da Contemplação</th>
            <th scope="col" class="px-4 py-3 min-w-[120px]">Valor Parcela</th>
        `;

        meses.forEach(mes => {
            const th = document.createElement('th');
            th.scope = 'col';
            th.className = 'px-4 py-3 min-w-[120px] text-center';
            th.textContent = mes;
            headerRow.appendChild(th);
            
            const option = document.createElement('option');
            option.value = mes;
            option.textContent = mes;
            mesReferenciaSelect.appendChild(option);
        });
        
        headerRow.appendChild(totalPagoHeader);
        headerRow.appendChild(acoesHeader);
    }

    // --- HANDLERS ---
    
    function handlePagamentoChange(e) {
        const participante = appData.participants.find(p => p.id === parseInt(e.target.dataset.id));
        if (participante) {
            participante.pagamentos[e.target.dataset.mes] = parseFloat(e.target.value) || 0;
            renderizarTabela();
        }
    }

    function handleStatusChange(e) {
        const participante = appData.participants.find(p => p.id === parseInt(e.target.dataset.id));
        if (participante) {
            participante.status = e.target.value;
            renderizarTabela();
        }
    }
    
    function handleMesContemplacaoChange(e) {
        const participante = appData.participants.find(p => p.id === parseInt(e.target.dataset.id));
        if (participante) {
            participante.mesContemplacao = e.target.value;
            if (e.target.value && participante.status === "Ativo") {
                participante.status = "Contemplado";
            }
            renderizarTabela();
        }
    }
    
    function handleEdit(e) {
        const id = parseInt(e.currentTarget.dataset.id);
        const participante = appData.participants.find(p => p.id === id);
        if(!participante) return;
        
        const novoNome = prompt("Digite o novo nome para:", participante.nome);
        if (novoNome && novoNome.trim() !== '') {
            participante.nome = novoNome.trim();
            renderizarTabela();
        }
    }

    function handleDelete(e) {
        participantIdToDelete = parseInt(e.currentTarget.dataset.id);
        deleteModal.classList.add('active');
    }

    formAdicionarCliente.addEventListener('submit', (e) => {
        e.preventDefault();
        const nome = document.getElementById('nomeCliente').value;
        const valorParcela = parseFloat(document.getElementById('valorParcela').value);
        
        if (nome && valorParcela > 0) {
            const novoId = appData.participants.length > 0 ? Math.max(...appData.participants.map(p => p.id)) + 1 : 1;
            const pagamentosIniciais = {};
            meses.forEach(mes => pagamentosIniciais[mes] = 0);
            
            appData.participants.push({
                id: novoId, nome: nome, valorParcela: valorParcela, status: 'Ativo',
                mesContemplacao: '', pagamentos: pagamentosIniciais
            });
            
            renderizarTabela();
            formAdicionarCliente.reset();
        }
    });

    // --- EVENT LISTENERS GLOBAIS ---
    mesReferenciaSelect.addEventListener('change', atualizarDashboard);
    productNameInput.addEventListener('input', (e) => {
        appData.product = e.target.value;
        salvarDados();
    });
    
    // Modal listeners
    cancelDeleteBtn.addEventListener('click', () => {
        deleteModal.classList.remove('active');
        participantIdToDelete = null;
    });

    confirmDeleteBtn.addEventListener('click', () => {
        if (participantIdToDelete !== null) {
            appData.participants = appData.participants.filter(p => p.id !== participantIdToDelete);
            deleteModal.classList.remove('active');
            participantIdToDelete = null;
            renderizarTabela();
        }
    });

    // --- INICIALIZAÇÃO DA APLICAÇÃO ---
    window.onload = () => {
        carregarDados();
        popularCabecalhoEMeses();
        renderizarTabela();
    };
</script>
</body>
</html>
