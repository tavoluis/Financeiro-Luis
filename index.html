<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Controle Financeiro (Login e Nuvem)</title>
    <style>
        :root {
            --primary-color: #007bff; --primary-dark: #0056b3; --secondary-color: #f4f7f9;
            --text-color: #343a40; --revenue-color: #28a745; --expenses-color: #dc3545;
            --balance-color: #17a2b8; --card-bg: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.08); --border-color: #e9ecef;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--secondary-color); color: var(--text-color); margin: 0; padding: 0; }
        .hidden { display: none !important; }
        
        /* Estilos da Tela de Login/Auth */
        #auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
        .auth-form-container { background-color: var(--card-bg); padding: 2rem; border-radius: 8px; box-shadow: var(--shadow); width: 100%; max-width: 400px; }
        .auth-form-container h2 { text-align: center; color: var(--primary-dark); }
        .auth-form-container .form-group { margin-bottom: 1rem; }
        .auth-form-container .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .auth-form-container .form-group input { width: 100%; padding: 0.75rem; border-radius: 5px; border: 1px solid var(--border-color); box-sizing: border-box; }
        .auth-form-container button[type="submit"] { width: 100%; padding: 0.75rem; border: none; border-radius: 5px; background-color: var(--primary-color); color: white; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .auth-form-container button[type="submit"]:hover { background-color: var(--primary-dark); }
        .auth-form-container .toggle-auth { text-align: center; margin-top: 1rem; font-size: 0.9rem; }
        .auth-form-container .toggle-auth a { color: var(--primary-color); cursor: pointer; text-decoration: underline; }
        #auth-error { color: var(--expenses-color); text-align: center; margin-top: 1rem; font-weight: bold; }

        /* Estilos do App Principal */
        #app-container { padding-bottom: 100px; }
        header { background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: white; padding: 1rem 1.5rem; text-align: center; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 1.5rem; flex-grow: 1; text-align: center; margin-left: 40px; }
        header .header-btn { background: none; border: none; color: white; font-size: 1.8rem; cursor: pointer; width: 40px; }
        footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--border-color); padding: 5px; text-align: center; font-size: 0.7rem; color: #6c757d; z-index: 100; }
        main { padding: 1rem; }
        .fab { position: fixed; bottom: 45px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background-color: var(--primary-color); color: white; font-size: 2.5rem; line-height: 56px; text-align: center; border: none; box-shadow: 0 6px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 1000; }
        /* Outros estilos do app (cards, modais, etc) continuam os mesmos */
        .period-selector, .summary-cards, .transaction-item, .modal-overlay, .modal-content { /* Estilos mantidos como antes */ }
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="auth-form-container">
            <!-- Formul치rio de Login -->
            <form id="login-form">
                <h2>Login</h2>
                <div id="login-error" class="hidden" style="color:red; text-align:center; margin-bottom:1rem;"></div>
                <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div>
                <div class="form-group"><label for="login-password">Senha</label><input type="password" id="login-password" required></div>
                <button type="submit">Entrar</button>
                <p class="toggle-auth">N칚o tem uma conta? <a id="show-register">Cadastre-se</a></p>
            </form>
            <!-- Formul치rio de Cadastro -->
            <form id="register-form" class="hidden">
                <h2>Cadastro</h2>
                <div id="register-error" class="hidden" style="color:red; text-align:center; margin-bottom:1rem;"></div>
                <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div>
                <div class="form-group"><label for="register-password">Senha (m칤nimo 6 caracteres)</label><input type="password" id="register-password" required></div>
                <button type="submit">Cadastrar</button>
                <p class="toggle-auth">J치 tem uma conta? <a id="show-login">Fa칞a Login</a></p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <header>
            <button id="logout-btn" class="header-btn" title="Sair">游뛁</button>
            <h1>Meu Controle Financeiro</h1>
            <button id="wallets-btn" class="header-btn" title="Gerenciar Carteiras">游눺</button>
        </header>

        <main>
            <!-- Conte칰do principal do app (igual ao anterior) -->
        </main>

        <button id="add-transaction-btn" class="fab">+</button>
        
        <footer>
            <span id="user-email-display" title="Usu치rio Logado"></span>
        </footer>
    </div>

    <!-- Modais (iguais aos anteriores) -->

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, writeBatch, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURA칂츾O ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "...", projectId: "..." };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ELEMENTOS DO DOM (AUTENTICA칂츾O) ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailDisplay = document.getElementById('user-email-display');

        // --- ESTADO ---
        let currentUser = null;
        let walletsUnsubscribe = null;
        let transactionsUnsubscribe = null;
        // ... (outros estados do app como wallets, transactions, currentDate)

        // --- L칍GICA DE AUTENTICA칂츾O ---
        
        // Alternar entre formul치rios de login e cadastro
        showRegisterBtn.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        });
        showLoginBtn.addEventListener('click', () => {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        // Cadastro
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = registerForm['register-email'].value;
            const password = registerForm['register-password'].value;
            const errorDiv = document.getElementById('register-error');
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // O onAuthStateChanged vai cuidar de mostrar o app
            } catch (error) {
                errorDiv.textContent = "Erro ao cadastrar: " + error.message;
                errorDiv.classList.remove('hidden');
            }
        });

        // Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            const errorDiv = document.getElementById('login-error');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // O onAuthStateChanged vai cuidar de mostrar o app
            } catch (error) {
                 errorDiv.textContent = "Email ou senha inv치lidos.";
                 errorDiv.classList.remove('hidden');
            }
        });
        
        // Logout
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // Monitorar estado de autentica칞칚o
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usu치rio est치 logado
                currentUser = user;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                userEmailDisplay.textContent = user.email;

                // Inicia a escuta por dados na nuvem
                setupFirestoreListeners(user.uid);
            } else {
                // Usu치rio est치 deslogado
                currentUser = null;
                appContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                
                // Limpa listeners antigos
                if (walletsUnsubscribe) walletsUnsubscribe();
                if (transactionsUnsubscribe) transactionsUnsubscribe();
            }
        });

        // --- L칍GICA DO APP (Firestore, Renderiza칞칚o, etc.) ---
        
        async function setupFirestoreListeners(userId) {
            // A mesma l칩gica de antes para escutar carteiras e transa칞칫es
            const walletsRef = collection(db, 'users', userId, 'wallets'); // Caminho simplificado
            const transactionsRef = collection(db, 'users', userId, 'transactions');
            
            walletsUnsubscribe = onSnapshot(walletsRef, (snapshot) => {
                // ... l칩gica para atualizar o array 'wallets' e renderizar
            });

            transactionsUnsubscribe = onSnapshot(transactionsRef, (snapshot) => {
                // ... l칩gica para atualizar o array 'transactions' e renderizar
            });
        }
        
        // ... TODAS AS OUTRAS FUN칂칏ES DO APLICATIVO (render, addWallet, deleteTransaction, etc)
        // devem ser mantidas aqui. A 칰nica diferen칞a 칠 que elas agora usar칚o o caminho do
        // banco de dados com o `currentUser.uid`, por exemplo:
        // const walletsRef = collection(db, 'users', currentUser.uid, 'wallets');

    </script>
</body>
</html>
