<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Controle Financeiro</title>
    <style>
        :root {
            --primary-color: #007bff; --primary-dark: #0056b3; --secondary-color: #f4f7f9;
            --text-color: #343a40; --revenue-color: #28a745; --expenses-color: #dc3545;
            --balance-color: #17a2b8; --pending-color: #ffc107; --card-bg: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.08); --border-color: #e9ecef;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--secondary-color); color: var(--text-color); margin: 0; padding-bottom: 100px;
        }
        header {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white; padding: 1rem 1.5rem; text-align: center; box-shadow: var(--shadow);
            position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center;
        }
        header h1 { margin: 0; font-size: 1.5rem; flex-grow: 1; text-align: center; margin-left: 40px; }
        header #wallets-btn { background: none; border: none; color: white; font-size: 1.8rem; cursor: pointer; width: 40px; }
        main { padding: 1rem; }
        .period-selector { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .period-selector button { background: none; border: 2px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; font-weight: bold; cursor: pointer; color: var(--primary-color); transition: all 0.2s; }
        .period-selector button:hover { background-color: var(--primary-color); color: white; }
        .period-selector h2 { margin: 0; font-size: 1.2rem; color: var(--primary-color); font-weight: 600; text-transform: capitalize; }
        .summary-cards { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 600px) { .summary-cards { grid-template-columns: repeat(3, 1fr); } }
        .card { background-color: var(--card-bg); padding: 1.2rem; border-radius: 8px; box-shadow: var(--shadow); border-left: 5px solid; }
        .card h3 { margin-top: 0; font-size: 1rem; color: #6c757d; margin-bottom: 0.5rem; }
        .card p { margin-bottom: 0; font-size: 1.75rem; font-weight: bold; }
        .card.revenue { border-color: var(--revenue-color); } .card.revenue p { color: var(--revenue-color); }
        .card.expenses { border-color: var(--expenses-color); } .card.expenses p { color: var(--expenses-color); }
        .card.balance { border-color: var(--balance-color); } .card.balance p { color: var(--balance-color); }
        #transactions h2 { border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; font-size: 1.2rem; }
        #transaction-list { margin-top: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .transaction-item { display: flex; align-items: center; background-color: var(--card-bg); padding: 1rem; border-radius: 8px; box-shadow: var(--shadow); border-left: 5px solid; transition: box-shadow 0.2s; }
        .transaction-item:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
        .transaction-item.revenue { border-color: var(--revenue-color); } .transaction-item.expense { border-color: var(--expenses-color); }
        .transaction-item .icon { font-size: 1.5rem; margin-right: 1rem; }
        .transaction-item .details { flex-grow: 1; } .transaction-item .details p { margin: 0; }
        .transaction-item .details .description { font-weight: 600; }
        .transaction-item .details .meta { font-size: 0.8rem; color: #6c757d; display: flex; align-items: center; gap: 5px; margin-top: 4px; }
        .transaction-item .amount { font-weight: bold; font-size: 1.1rem; margin-left: 1rem; }
        .transaction-actions { display: flex; gap: 0.5rem; } .transaction-actions button { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 0.3rem; color: #6c757d; transition: all 0.2s; }
        .transaction-actions button:hover { transform: scale(1.2); } .transaction-actions .edit-btn:hover { color: var(--primary-color); } .transaction-actions .delete-btn:hover { color: var(--expenses-color); }
        #transaction-list .empty-state { color: #6c757d; text-align: center; padding: 2rem; background-color: var(--card-bg); border-radius: 8px; }
        .fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background-color: var(--primary-color); color: white; font-size: 2.5rem; line-height: 56px; text-align: center; border: none; box-shadow: 0 6px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 1000; transition: all 0.2s; }
        .fab:hover { transform: scale(1.1); background-color: var(--primary-dark); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0s 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.3s; max-height: 80vh; display: flex; flex-direction: column; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content h2 { margin-top: 0; } .modal-body { overflow-y: auto; }
        .form-group { margin-bottom: 1rem; } .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border-radius: 5px; border: 1px solid var(--border-color); box-sizing: border-box; }
        .type-selector { display: flex; gap: 10px; margin-bottom: 1rem; }
        .type-selector button { flex: 1; padding: 0.75rem; border-radius: 5px; border: 2px solid var(--border-color); background-color: var(--secondary-color); font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .type-selector button.active.revenue { background-color: var(--revenue-color); border-color: var(--revenue-color); color: white; }
        .type-selector button.active.expense { background-color: var(--expenses-color); border-color: var(--expenses-color); color: white; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .modal-actions button { padding: 0.75rem 1.5rem; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .modal-actions button:hover { opacity: 0.8; }
        .modal-actions .cancel-btn { background-color: #6c757d; color: white; }
        .modal-actions .confirm-btn { background-color: var(--primary-color); color: white; }
        .modal-actions .delete-confirm-btn { background-color: var(--expenses-color); color: white; }
        #confirm-delete-modal .modal-content, #alert-modal .modal-content { max-width: 400px; text-align: center; }
        #wallets-modal #wallet-list { list-style: none; padding: 0; margin: 0; }
        #wallets-modal #wallet-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-color); }
        #wallets-modal #wallet-list li:last-child { border-bottom: none; }
        #wallets-modal .delete-wallet-btn { background: none; border: none; color: var(--expenses-color); font-size: 1.2rem; cursor: pointer; }
        #add-wallet-form { display: flex; gap: 10px; margin-top: 1rem; }
        #add-wallet-form input { flex-grow: 1; }
        #add-wallet-form button { white-space: nowrap; }
    </style>
</head>
<body>
    <header><h1>Meu Controle Financeiro</h1><button id="wallets-btn" title="Gerenciar Carteiras">💼</button></header>
    <main>
        <section id="dashboard">
            <div class="period-selector">
                <button id="prev-month-btn">&lt;</button><h2 id="current-month-display"></h2><button id="next-month-btn">&gt;</button>
            </div>
            <div class="summary-cards">
                <div class="card revenue"><h3>Receita do Mês</h3><p id="total-revenue">R$ 0,00</p></div>
                <div class="card expenses"><h3>Despesa do Mês</h3><p id="total-expenses">R$ 0,00</p></div>
                <div class="card balance"><h3>Balanço</h3><p id="balance">R$ 0,00</p></div>
            </div>
        </section>
        <section id="transactions"><h2>Lançamentos</h2><div id="transaction-list"></div></section>
    </main>
    <button id="add-transaction-btn" class="fab">+</button>

    <div id="transaction-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">Novo Lançamento</h2>
            <div class="modal-body">
                <form id="transaction-form">
                    <input type="hidden" id="transaction-id">
                    <div class="type-selector"><button type="button" id="type-revenue-btn" class="revenue">Receita</button><button type="button" id="type-expense-btn" class="expense">Despesa</button></div>
                    <div class="form-group"><label for="description">Descrição</label><input type="text" id="description" required></div>
                    <div class="form-group"><label for="amount">Valor</label><input type="number" id="amount" step="0.01" min="0" required></div>
                    <div class="form-group"><label for="date">Data</label><input type="date" id="date" required></div>
                    <div class="form-group"><label for="wallet">Carteira</label><select id="wallet" required></select></div>
                </form>
            </div>
            <div class="modal-actions"><button type="button" class="cancel-btn">Cancelar</button><button type="submit" form="transaction-form" class="confirm-btn">Salvar</button></div>
        </div>
    </div>
    
    <div id="wallets-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Gerenciar Carteiras</h2>
            <div class="modal-body"><ul id="wallet-list"></ul><form id="add-wallet-form"><div class="form-group" style="flex-grow:1; margin:0;"><label for="new-wallet-name" class="sr-only">Nova Carteira</label><input type="text" id="new-wallet-name" placeholder="Nome da nova carteira" required></div><button type="submit" class="confirm-btn">Adicionar</button></form></div>
            <div class="modal-actions"><button type="button" class="cancel-btn">Fechar</button></div>
        </div>
    </div>

    <div id="confirm-delete-modal" class="modal-overlay">
        <div class="modal-content"><h2>Confirmar Exclusão</h2><p>Você tem certeza que deseja apagar este item? Esta ação não pode ser desfeita.</p><div class="modal-actions"><button type="button" class="cancel-btn">Cancelar</button><button type="button" id="delete-confirm-btn" class="delete-confirm-btn">Excluir</button></div></div>
    </div>
    
    <div id="alert-modal" class="modal-overlay">
        <div class="modal-content"><h2>Aviso</h2><p id="alert-message"></p><div class="modal-actions"><button type="button" class="cancel-btn confirm-btn">OK</button></div></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ELEMENTOS DO DOM ---
    const modals = {
        transaction: document.getElementById('transaction-modal'),
        wallets: document.getElementById('wallets-modal'),
        confirmDelete: document.getElementById('confirm-delete-modal'),
        alert: document.getElementById('alert-modal')
    };
    const addTransactionBtn = document.getElementById('add-transaction-btn');
    const transactionForm = document.getElementById('transaction-form');
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');
    const totalRevenueEl = document.getElementById('total-revenue');
    const totalExpensesEl = document.getElementById('total-expenses');
    const balanceEl = document.getElementById('balance');
    const currentMonthDisplay = document.getElementById('current-month-display');
    const transactionList = document.getElementById('transaction-list');
    const typeRevenueBtn = document.getElementById('type-revenue-btn');
    const typeExpenseBtn = document.getElementById('type-expense-btn');
    const descriptionInput = document.getElementById('description');
    const amountInput = document.getElementById('amount');
    const dateInput = document.getElementById('date');
    const walletSelect = document.getElementById('wallet');
    const transactionIdInput = document.getElementById('transaction-id');
    const modalTitle = document.getElementById('modal-title');
    const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
    const walletsBtn = document.getElementById('wallets-btn');
    const addWalletForm = document.getElementById('add-wallet-form');
    const walletListEl = document.getElementById('wallet-list');
    const newWalletNameInput = document.getElementById('new-wallet-name');
    const alertMessageEl = document.getElementById('alert-message');

    // --- ESTADO DA APLICAÇÃO ---
    let transactions = JSON.parse(localStorage.getItem('transactions_v3')) || [];
    let wallets = JSON.parse(localStorage.getItem('wallets_v3')) || [];
    let currentDate = new Date();
    let selectedType = 'expense';
    let itemToDelete = { id: null, type: null };

    // --- FUNÇÕES ---
    const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    const openModal = (modal) => modal.classList.add('active');
    const closeModal = (modal) => modal.classList.remove('active');
    const showAlert = (message) => {
        alertMessageEl.textContent = message;
        openModal(modals.alert);
    };

    const saveToLocalStorage = () => {
        localStorage.setItem('transactions_v3', JSON.stringify(transactions));
        localStorage.setItem('wallets_v3', JSON.stringify(wallets));
    };

    const populateWalletSelect = () => {
        walletSelect.innerHTML = '';
        wallets.forEach(w => {
            const option = document.createElement('option');
            option.value = w.id;
            option.textContent = w.name;
            walletSelect.appendChild(option);
        });
    };

    const setupTransactionModal = (transaction = null) => {
        transactionForm.reset();
        populateWalletSelect();
        if (transaction) {
            modalTitle.textContent = 'Editar Lançamento';
            transactionIdInput.value = transaction.id;
            selectTransactionType(transaction.type);
            descriptionInput.value = transaction.description;
            amountInput.value = transaction.amount;
            dateInput.value = transaction.date;
            walletSelect.value = transaction.walletId;
        } else {
            modalTitle.textContent = 'Novo Lançamento';
            transactionIdInput.value = '';
            dateInput.value = new Date().toISOString().split('T')[0];
            selectTransactionType('expense');
        }
        openModal(modals.transaction);
    };
    
    const selectTransactionType = (type) => {
        selectedType = type;
        typeRevenueBtn.classList.toggle('active', type === 'revenue');
        typeExpenseBtn.classList.toggle('active', type === 'expense');
    };

    const render = () => {
        const filteredTransactions = transactions.filter(t => {
            const transactionDate = new Date(t.date);
            const adjustedDate = new Date(transactionDate.valueOf() + transactionDate.getTimezoneOffset() * 60 * 1000);
            return adjustedDate.getMonth() === currentDate.getMonth() && adjustedDate.getFullYear() === currentDate.getFullYear();
        });

        let totalRevenue = 0, totalExpenses = 0;
        transactionList.innerHTML = '';

        if (filteredTransactions.length === 0) {
            transactionList.innerHTML = `<div class="empty-state"><p>Nenhum lançamento para este mês.</p></div>`;
        } else {
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            filteredTransactions.forEach(t => {
                if (t.type === 'revenue') totalRevenue += t.amount; else totalExpenses += t.amount;
                const wallet = wallets.find(w => w.id === t.walletId);
                const item = document.createElement('div');
                item.className = `transaction-item ${t.type}`;
                item.dataset.id = t.id;
                item.innerHTML = `
                    <div class="icon">${t.type === 'revenue' ? '📈' : '📉'}</div>
                    <div class="details">
                        <p class="description">${t.description}</p>
                        <div class="meta">
                            <span>${new Date(t.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</span> • 
                            <span>${wallet ? wallet.name : 'Carteira removida'}</span>
                        </div>
                    </div>
                    <div class="amount" style="color: ${t.type === 'revenue' ? 'var(--revenue-color)' : 'var(--expenses-color)'}">
                        ${t.type === 'revenue' ? '+' : '-'} ${formatCurrency(t.amount)}
                    </div>
                    <div class="transaction-actions">
                        <button class="edit-btn" title="Editar">✏️</button>
                        <button class="delete-btn" title="Excluir">🗑️</button>
                    </div>`;
                transactionList.appendChild(item);
            });
        }
        
        totalRevenueEl.textContent = formatCurrency(totalRevenue);
        totalExpensesEl.textContent = formatCurrency(totalExpenses);
        const balance = totalRevenue - totalExpenses;
        balanceEl.textContent = formatCurrency(balance);
        balanceEl.style.color = balance < 0 ? 'var(--expenses-color)' : 'var(--balance-color)';
        currentMonthDisplay.textContent = currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
    };

    const handleFormSubmit = (event) => {
        event.preventDefault();
        const id = transactionIdInput.value;
        if (wallets.length === 0) {
            showAlert("Você precisa criar uma carteira antes de adicionar um lançamento.");
            return;
        }
        const transactionData = {
            description: descriptionInput.value,
            amount: parseFloat(amountInput.value),
            date: dateInput.value,
            type: selectedType,
            walletId: parseInt(walletSelect.value)
        };
        if (id) {
            transactions = transactions.map(t => t.id == id ? { ...t, ...transactionData } : t);
        } else {
            transactions.push({ id: Date.now(), ...transactionData });
        }
        saveToLocalStorage();
        render();
        closeModal(modals.transaction);
    };

    const handleTransactionClick = (e) => {
        const actionButton = e.target.closest('.edit-btn, .delete-btn');
        if (!actionButton) return;
        const id = parseInt(actionButton.closest('.transaction-item').dataset.id);
        if (actionButton.classList.contains('edit-btn')) {
            const transactionToEdit = transactions.find(t => t.id === id);
            setupTransactionModal(transactionToEdit);
        } else {
            itemToDelete = { id, type: 'transaction' };
            openModal(modals.confirmDelete);
        }
    };

    const renderWallets = () => {
        walletListEl.innerHTML = '';
        wallets.forEach(w => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span>${w.name}</span>
                <button class="delete-wallet-btn" data-id="${w.id}" title="Excluir Carteira">🗑️</button>`;
            walletListEl.appendChild(li);
        });
    };

    const handleAddWallet = (e) => {
        e.preventDefault();
        const name = newWalletNameInput.value.trim();
        if (name) {
            wallets.push({ id: Date.now(), name });
            newWalletNameInput.value = '';
            saveToLocalStorage();
            renderWallets();
        }
    };

    const handleWalletListClick = (e) => {
        if (e.target.classList.contains('delete-wallet-btn')) {
            const id = parseInt(e.target.dataset.id);
            const isWalletInUse = transactions.some(t => t.walletId === id);
            if(isWalletInUse) {
                showAlert("Não é possível excluir esta carteira, pois ela está sendo usada em um ou mais lançamentos.");
                return;
            }
            itemToDelete = { id, type: 'wallet' };
            openModal(modals.confirmDelete);
        }
    };

    const handleDeleteConfirm = () => {
        if (itemToDelete.type === 'transaction') {
            transactions = transactions.filter(t => t.id !== itemToDelete.id);
        } else if (itemToDelete.type === 'wallet') {
            wallets = wallets.filter(w => w.id !== itemToDelete.id);
            renderWallets();
        }
        saveToLocalStorage();
        render();
        closeModal(modals.confirmDelete);
        itemToDelete = { id: null, type: null };
    };

    // --- EVENT LISTENERS ---
    addTransactionBtn.addEventListener('click', () => setupTransactionModal());
    transactionForm.addEventListener('submit', handleFormSubmit);
    transactionList.addEventListener('click', handleTransactionClick);
    prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); render(); });
    nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); render(); });
    typeRevenueBtn.addEventListener('click', () => selectTransactionType('revenue'));
    typeExpenseBtn.addEventListener('click', () => selectTransactionType('expense'));
    deleteConfirmBtn.addEventListener('click', handleDeleteConfirm);
    walletsBtn.addEventListener('click', () => { renderWallets(); openModal(modals.wallets); });
    addWalletForm.addEventListener('submit', handleAddWallet);
    walletListEl.addEventListener('click', handleWalletListClick);
    Object.values(modals).forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal || e.target.classList.contains('cancel-btn')) closeModal(modal);
        });
    });

    // --- INICIALIZAÇÃO ---
    function initialize() {
        if (wallets.length === 0) {
            wallets.push({ id: Date.now(), name: "Carteira Principal" });
            saveToLocalStorage();
        }
        // Migração de dados de lançamentos antigos sem carteira
        let needsSave = false;
        transactions.forEach(t => {
            if(typeof t.walletId === 'undefined') {
                t.walletId = wallets[0].id; // Associa à primeira carteira
                needsSave = true;
            }
        });
        if(needsSave) saveToLocalStorage();
        render();
    }
    initialize();
});
</script>
</body>
</html>
