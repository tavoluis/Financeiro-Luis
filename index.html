<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Controle Financeiro (Nuvem)</title>
    <style>
        :root {
            --primary-color: #007bff; --primary-dark: #0056b3; --secondary-color: #f4f7f9;
            --text-color: #343a40; --revenue-color: #28a745; --expenses-color: #dc3545;
            --balance-color: #17a2b8; --pending-color: #ffc107; --card-bg: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.08); --border-color: #e9ecef;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--secondary-color); color: var(--text-color); margin: 0; padding-bottom: 100px; }
        .hidden { display: none !important; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid var(--primary-color); width: 60px; height: 60px; animation: spin 1s linear infinite; }
        #loading-overlay p { margin-top: 1rem; font-weight: bold; color: var(--primary-dark); }
        #retry-connection-btn { margin-top: 1rem; padding: 10px 20px; font-size: 1rem; font-weight: bold; color: white; background-color: var(--primary-color); border: none; border-radius: 5px; cursor: pointer; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        header { background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: white; padding: 1rem 1.5rem; text-align: center; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 1.5rem; flex-grow: 1; text-align: center; }
        header #wallets-btn { background: none; border: none; color: white; font-size: 1.8rem; cursor: pointer; width: 40px; }
        footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--border-color); padding: 5px; text-align: center; font-size: 0.7rem; color: #6c757d; z-index: 100; }
        footer input { width: 90%; max-width: 400px; border: none; background: transparent; text-align: center; cursor: pointer; }
        main { padding: 1rem; }
        .period-selector { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .period-selector button { background: none; border: 2px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; font-weight: bold; cursor: pointer; color: var(--primary-color); transition: all 0.2s; }
        .period-selector button:hover { background-color: var(--primary-color); color: white; }
        .period-selector h2 { margin: 0; font-size: 1.2rem; color: var(--primary-color); font-weight: 600; text-transform: capitalize; }
        .summary-cards { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 600px) { .summary-cards { grid-template-columns: repeat(3, 1fr); } }
        .card { background-color: var(--card-bg); padding: 1.2rem; border-radius: 8px; box-shadow: var(--shadow); border-left: 5px solid; }
        .card h3 { margin-top: 0; font-size: 1rem; color: #6c757d; margin-bottom: 0.5rem; }
        .card p { margin-bottom: 0; font-size: 1.75rem; font-weight: bold; }
        .card.revenue { border-color: var(--revenue-color); } .card.revenue p { color: var(--revenue-color); }
        .card.expenses { border-color: var(--expenses-color); } .card.expenses p { color: var(--expenses-color); }
        .card.balance { border-color: var(--balance-color); } .card.balance p { color: var(--balance-color); }
        #transaction-list { margin-top: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .transaction-item { display: flex; align-items: center; background-color: var(--card-bg); padding: 1rem; border-radius: 8px; box-shadow: var(--shadow); border-left: 5px solid; transition: box-shadow 0.2s; }
        .transaction-item.revenue { border-color: var(--revenue-color); } .transaction-item.expense { border-color: var(--expenses-color); }
        .transaction-item .icon { font-size: 1.5rem; margin-right: 1rem; }
        .transaction-item .details { flex-grow: 1; } .transaction-item .details p { margin: 0; }
        .transaction-item .details .description { font-weight: 600; }
        .transaction-item .details .meta { font-size: 0.8rem; color: #6c757d; display: flex; align-items: center; flex-wrap: wrap; gap: 5px; margin-top: 4px; }
        .transaction-item .amount { font-weight: bold; font-size: 1.1rem; margin-left: 1rem; text-align: right; }
        .transaction-actions { display: flex; gap: 0.5rem; } .transaction-actions button { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 0.3rem; color: #6c757d; }
        .fab { position: fixed; bottom: 45px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background-color: var(--primary-color); color: white; font-size: 2.5rem; line-height: 56px; text-align: center; border: none; box-shadow: 0 6px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 1000; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0s 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.3s; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-body { overflow-y: auto; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader"></div>
        <p id="loading-message">Conectando e sincronizando...</p>
        <button id="retry-connection-btn" class="hidden">Recarregar</button>
    </div>

    <div id="app-container" class="hidden">
        <header>
            <h1>Meu Controle Financeiro</h1>
            <button id="wallets-btn" title="Gerenciar Carteiras">💼</button>
        </header>

        <main>
            <section id="dashboard">
                <div class="period-selector">
                    <button id="prev-month-btn">&lt;</button>
                    <h2 id="current-month-display"></h2>
                    <button id="next-month-btn">&gt;</button>
                </div>
                <div class="summary-cards">
                    <div class="card revenue"><h3>Receita do Mês</h3><p id="total-revenue">R$ 0,00</p></div>
                    <div class="card expenses"><h3>Despesa do Mês</h3><p id="total-expenses">R$ 0,00</p></div>
                    <div class="card balance"><h3>Balanço</h3><p id="balance">R$ 0,00</p></div>
                </div>
            </section>
            <section id="transactions">
                <h2>Lançamentos</h2>
                <div id="transaction-list"></div>
            </section>
        </main>

        <button id="add-transaction-btn" class="fab">+</button>
        
        <footer>
            <input type="text" id="user-id-display" readonly title="Seu ID na nuvem. Clique para copiar.">
        </footer>
    </div>

    <!-- Modals -->
    <div id="transaction-modal" class="modal-overlay"> <div class="modal-content"> <h2 id="modal-title">Novo Lançamento</h2> <div class="modal-body"> <form id="transaction-form"> <input type="hidden" id="transaction-id"> <div class="type-selector" style="display: flex; gap: 10px; margin-bottom: 1rem;"> <button type="button" id="type-revenue-btn" class="revenue" style="flex: 1; padding: 0.75rem;">Receita</button> <button type="button" id="type-expense-btn" class="expense" style="flex: 1; padding: 0.75rem;">Despesa</button> </div> <div class="form-group"> <label for="description">Descrição</label> <input type="text" id="description" required> </div> <div class="form-group"> <label for="amount">Valor</label> <input type="number" id="amount" step="0.01" min="0" required> </div> <div class="form-group"> <label for="date">Data</label> <input type="date" id="date" required> </div> <div class="form-group"> <label for="wallet">Carteira</label> <select id="wallet" required></select> </div> </form> </div> <div class="modal-actions"> <button type="button" class="cancel-btn">Cancelar</button> <button type="submit" form="transaction-form" class="confirm-btn">Salvar</button> </div> </div> </div>
    <div id="wallets-modal" class="modal-overlay"> <div class="modal-content"> <h2>Gerenciar Carteiras</h2> <div class="modal-body"> <ul id="wallet-list"></ul> <form id="add-wallet-form" style="display: flex; gap: 10px; margin-top: 1rem;"> <input type="text" id="new-wallet-name" placeholder="Nome da nova carteira" required style="flex-grow:1;"> <button type="submit" class="confirm-btn">Adicionar</button> </form> </div> <div class="modal-actions"> <button type="button" class="cancel-btn">Fechar</button> </div> </div> </div>
    <div id="confirm-delete-modal" class="modal-overlay"> <div class="modal-content" style="text-align: center;"> <h2>Confirmar Exclusão</h2> <p>Você tem certeza?</p> <div class="modal-actions"> <button type="button" class="cancel-btn">Cancelar</button> <button type="button" id="delete-confirm-btn" class="delete-confirm-btn" style="background-color: var(--expenses-color); color: white;">Excluir</button> </div> </div> </div>
    <div id="alert-modal" class="modal-overlay"> <div class="modal-content" style="text-align: center;"> <h2>Aviso</h2> <p id="alert-message"></p> <div class="modal-actions"> <button type="button" class="cancel-btn confirm-btn">OK</button> </div> </div> </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, writeBatch, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO E INICIALIZAÇÃO ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "...", projectId: "..." };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ELEMENTOS DO DOM ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const retryBtn = document.getElementById('retry-connection-btn');
        const appContainer = document.getElementById('app-container');
        const userIdDisplay = document.getElementById('user-id-display');
        const walletsBtn = document.getElementById('wallets-btn');
        const addTransactionBtn = document.getElementById('add-transaction-btn');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        
        const modals = {
            transaction: document.getElementById('transaction-modal'),
            wallets: document.getElementById('wallets-modal'),
            confirmDelete: document.getElementById('confirm-delete-modal'),
            alert: document.getElementById('alert-modal')
        };
        const transactionForm = document.getElementById('transaction-form');
        const addWalletForm = document.getElementById('add-wallet-form');
        const deleteConfirmBtn = document.getElementById('delete-confirm-btn');

        // --- ESTADO DA APLICAÇÃO ---
        let wallets = [];
        let transactions = [];
        let currentUser = null;
        let currentDate = new Date();
        let itemToDelete = null;

        let walletsUnsubscribe = null;
        let transactionsUnsubscribe = null;
        
        // --- FUNÇÕES DE RENDERIZAÇÃO E UI ---
        const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        function render() {
            if (!currentUser) return;
            renderSummary();
            renderTransactionList();
        }

        function renderSummary() {
            document.getElementById('current-month-display').textContent = currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            const filtered = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const adjustedDate = new Date(transactionDate.valueOf() + transactionDate.getTimezoneOffset() * 60 * 1000);
                return adjustedDate.getMonth() === currentDate.getMonth() && adjustedDate.getFullYear() === currentDate.getFullYear();
            });

            const totalRevenue = filtered.reduce((acc, t) => t.type === 'revenue' ? acc + t.amount : acc, 0);
            const totalExpenses = filtered.reduce((acc, t) => t.type === 'expense' ? acc + t.amount : acc, 0);
            const balance = totalRevenue - totalExpenses;

            document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('balance').textContent = formatCurrency(balance);
            document.getElementById('balance').style.color = balance < 0 ? 'var(--expenses-color)' : 'var(--balance-color)';
        }
        
        function renderTransactionList() {
            const listEl = document.getElementById('transaction-list');
            const filtered = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const adjustedDate = new Date(transactionDate.valueOf() + transactionDate.getTimezoneOffset() * 60 * 1000);
                return adjustedDate.getMonth() === currentDate.getMonth() && adjustedDate.getFullYear() === currentDate.getFullYear();
            }).sort((a,b) => new Date(b.date) - new Date(a.date));

            if (filtered.length === 0) {
                listEl.innerHTML = `<div style="text-align: center; color: #6c757d; padding: 2rem;">Nenhum lançamento para este mês.</div>`;
                return;
            }

            listEl.innerHTML = filtered.map(t => {
                const wallet = wallets.find(w => w.id === t.walletId);
                return `
                <div class="transaction-item ${t.type}" data-id="${t.id}">
                    <div class="icon">${t.type === 'revenue' ? '📈' : '📉'}</div>
                    <div class="details">
                        <p class="description">${t.description}</p>
                        <div class="meta"><span>${new Date(t.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</span> • <span>${wallet ? wallet.name : ''}</span></div>
                    </div>
                    <div class="amount" style="color: ${t.type === 'revenue' ? 'var(--revenue-color)' : 'var(--expenses-color)'}">${t.type === 'revenue' ? '+' : '-'} ${formatCurrency(t.amount)}</div>
                    <div class="transaction-actions"><button class="edit-btn" title="Editar">✏️</button><button class="delete-btn" title="Excluir">🗑️</button></div>
                </div>`;
            }).join('');
        }

        function renderWallets() {
            const listEl = document.getElementById('wallet-list');
            if (wallets.length === 0) {
                listEl.innerHTML = `<li>Nenhuma carteira encontrada.</li>`;
                return;
            }
            listEl.innerHTML = wallets.map(w => {
                const balance = transactions.reduce((acc, t) => t.walletId === w.id ? acc + (t.type === 'revenue' ? t.amount : -t.amount) : acc, 0);
                return `
                <li style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;">
                    <div>${w.name} <strong style="color: ${balance < 0 ? 'var(--expenses-color)' : 'var(--revenue-color)'};">${formatCurrency(balance)}</strong></div>
                    <button class="delete-wallet-btn" data-id="${w.id}" title="Excluir" style="background:none; border:none; cursor:pointer; font-size: 1.2rem;">🗑️</button>
                </li>`;
            }).join('');
        }

        const openModal = (modal) => modal.classList.add('active');
        const closeModal = (modal) => modal.classList.remove('active');
        const showAlert = (message) => { document.getElementById('alert-message').textContent = message; openModal(modals.alert); };

        // --- AUTENTICAÇÃO ---
        onAuthStateChanged(auth, async (user) => {
            // Limpa listeners antigos para evitar duplicação
            if (walletsUnsubscribe) walletsUnsubscribe();
            if (transactionsUnsubscribe) transactionsUnsubscribe();

            if (user) {
                // Usuário está logado
                loadingOverlay.classList.remove('hidden');
                appContainer.classList.add('hidden');
                
                currentUser = user;
                userIdDisplay.value = user.uid;
                await setupFirestoreListeners(user.uid);
                
                loadingOverlay.classList.add('hidden');
                appContainer.classList.remove('hidden');
            } else {
                // Usuário deslogado, tenta logar
                loadingOverlay.classList.remove('hidden');
                appContainer.classList.add('hidden');
                try {
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Erro no login:", error);
                    loadingOverlay.querySelector('.loader').classList.add('hidden');
                    loadingMessage.textContent = "Erro de conexão.";
                    retryBtn.classList.remove('hidden');
                }
            }
        });
        
        // --- SINCRONIZAÇÃO COM FIRESTORE ---
        async function setupFirestoreListeners(userId) {
            const walletsRef = collection(db, 'artifacts', appId, 'users', userId, 'wallets');
            const transactionsRef = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
            
            walletsUnsubscribe = onSnapshot(walletsRef, (snapshot) => {
                wallets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Garante que uma carteira principal seja criada apenas uma vez.
                if (snapshot.docs.length === 0 && !snapshot.metadata.hasPendingWrites) {
                    addDoc(walletsRef, { name: "Carteira Principal", createdAt: new Date() });
                }
                render();
            });

            transactionsUnsubscribe = onSnapshot(transactionsRef, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
        }
        
        // --- FUNÇÕES CRUD (FIRESTORE) ---
        function getCollections() {
            if (!currentUser) throw new Error("Usuário não autenticado");
            return {
                walletsRef: collection(db, 'artifacts', appId, 'users', currentUser.uid, 'wallets'),
                transactionsRef: collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions')
            };
        }

        async function handleAddWallet(e) {
            e.preventDefault();
            const input = document.getElementById('new-wallet-name');
            const name = input.value.trim();
            if (name) {
                await addDoc(getCollections().walletsRef, { name, createdAt: new Date() });
                input.value = '';
            }
        }

        async function handleDeleteWallet(id) {
            const isInUse = transactions.some(t => t.walletId === id);
            if (isInUse) {
                showAlert("Não é possível excluir. A carteira está sendo usada em lançamentos.");
                return;
            }
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'wallets', id);
            await deleteDoc(docRef);
            renderWallets();
        }

        async function handleTransactionSubmit(e) {
            e.preventDefault();
            const id = transactionForm.elements['transaction-id'].value;
            const transactionData = {
                description: transactionForm.elements['description'].value,
                amount: parseFloat(transactionForm.elements['amount'].value),
                date: transactionForm.elements['date'].value,
                walletId: transactionForm.elements['wallet'].value,
                type: transactionForm.querySelector('.type-selector button.active').id.includes('revenue') ? 'revenue' : 'expense'
            };

            if (id) {
                const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', id);
                await updateDoc(docRef, transactionData);
            } else {
                await addDoc(getCollections().transactionsRef, transactionData);
            }
            closeModal(modals.transaction);
        }
        
        async function handleDeleteTransaction(id) {
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', id);
            await deleteDoc(docRef);
        }

        // --- EVENT LISTENERS ---
        retryBtn.addEventListener('click', () => location.reload());
        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); render(); });
        nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); render(); });
        
        addTransactionBtn.addEventListener('click', () => {
            transactionForm.reset();
            transactionForm.elements['transaction-id'].value = '';
            document.getElementById('modal-title').textContent = 'Novo Lançamento';
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            const walletSelect = document.getElementById('wallet');
            walletSelect.innerHTML = wallets.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
            document.getElementById('type-expense-btn').classList.add('active');
            document.getElementById('type-revenue-btn').classList.remove('active');
            openModal(modals.transaction);
        });

        walletsBtn.addEventListener('click', () => { renderWallets(); openModal(modals.wallets); });

        transactionForm.addEventListener('submit', handleTransactionSubmit);
        addWalletForm.addEventListener('submit', handleAddWallet);
        deleteConfirmBtn.addEventListener('click', async () => {
            if(itemToDelete && itemToDelete.type === 'transaction') await handleDeleteTransaction(itemToDelete.id);
            if(itemToDelete && itemToDelete.type === 'wallet') await handleDeleteWallet(itemToDelete.id);
            closeModal(modals.confirmDelete);
            itemToDelete = null;
        });
        
        document.getElementById('transaction-list').addEventListener('click', e => {
            if (e.target.closest('.delete-btn')) {
                const id = e.target.closest('.transaction-item').dataset.id;
                itemToDelete = { type: 'transaction', id };
                openModal(modals.confirmDelete);
            }
            if (e.target.closest('.edit-btn')) {
                const id = e.target.closest('.transaction-item').dataset.id;
                const t = transactions.find(tr => tr.id === id);
                if(!t) return;
                
                transactionForm.reset();
                transactionForm.elements['transaction-id'].value = t.id;
                document.getElementById('modal-title').textContent = 'Editar Lançamento';
                
                const walletSelect = document.getElementById('wallet');
                walletSelect.innerHTML = wallets.map(w => `<option value="${w.id}" ${w.id == t.walletId ? 'selected' : ''}>${w.name}</option>`).join('');

                transactionForm.elements['description'].value = t.description;
                transactionForm.elements['amount'].value = t.amount;
                transactionForm.elements['date'].value = t.date;
                
                document.getElementById('type-expense-btn').classList.toggle('active', t.type === 'expense');
                document.getElementById('type-revenue-btn').classList.toggle('active', t.type === 'revenue');

                openModal(modals.transaction);
            }
        });
        
        document.getElementById('wallet-list').addEventListener('click', e => {
            if (e.target.closest('.delete-wallet-btn')) {
                const id = e.target.closest('.delete-wallet-btn').dataset.id;
                itemToDelete = { type: 'wallet', id };
                openModal(modals.confirmDelete);
            }
        });

        transactionForm.querySelector('.type-selector').addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                transactionForm.querySelector('.type-selector button.active').classList.remove('active');
                e.target.classList.add('active');
            }
        });

        userIdDisplay.addEventListener('click', () => {
            try {
                userIdDisplay.select();
                userIdDisplay.setSelectionRange(0, 99999); // Para dispositivos móveis
                document.execCommand('copy');
                window.getSelection().removeAllRanges(); // Desseleciona o texto
                showAlert("ID do usuário copiado para a área de transferência!");
            } catch (err) {
                console.error('Erro ao copiar:', err);
                showAlert("Falha ao copiar. Por favor, copie o ID manualmente.");
            }
        });

        Object.values(modals).forEach(modal => {
            modal.addEventListener('click', e => { if (e.target === modal || e.target.classList.contains('cancel-btn')) closeModal(modal); });
        });
    </script>
</body>
</html>
