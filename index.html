<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Controle Financeiro (Login e Nuvem)</title>
    <style>
        :root {
            --primary-color: #007bff; --primary-dark: #0056b3; --secondary-color: #f4f7f9;
            --text-color: #343a40; --revenue-color: #28a745; --expenses-color: #dc3545;
            --balance-color: #17a2b8; --card-bg: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.08); --border-color: #e9ecef;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--secondary-color); color: var(--text-color); margin: 0; padding: 0; }
        .hidden { display: none !important; }
        
        #auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
        .auth-form-container { background-color: var(--card-bg); padding: 2rem; border-radius: 8px; box-shadow: var(--shadow); width: 100%; max-width: 400px; }
        .auth-form-container h2 { text-align: center; color: var(--primary-dark); }
        .auth-form-container .form-group { margin-bottom: 1rem; }
        .auth-form-container .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .auth-form-container .form-group input { width: 100%; padding: 0.75rem; border-radius: 5px; border: 1px solid var(--border-color); box-sizing: border-box; }
        .auth-form-container button[type="submit"] { width: 100%; padding: 0.75rem; border: none; border-radius: 5px; background-color: var(--primary-color); color: white; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .auth-form-container button[type="submit"]:hover { background-color: var(--primary-dark); }
        .auth-form-container .toggle-auth { text-align: center; margin-top: 1rem; font-size: 0.9rem; }
        .auth-form-container .toggle-auth a { color: var(--primary-color); cursor: pointer; text-decoration: underline; }
        .auth-error { color: var(--expenses-color); text-align: center; margin-bottom: 1rem; font-weight: bold; }

        #app-container { padding-bottom: 100px; }
        header { background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: white; padding: 1rem 1.5rem; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 1.5rem; flex-grow: 1; text-align: center; margin-left: 40px; }
        header .header-btn { background: none; border: none; color: white; font-size: 1.8rem; cursor: pointer; width: 40px; }
        footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--border-color); padding: 5px; text-align: center; font-size: 0.7rem; color: #6c757d; z-index: 100; }
        main { padding: 1rem; }
        .fab { position: fixed; bottom: 45px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background-color: var(--primary-color); color: white; font-size: 2.5rem; line-height: 56px; text-align: center; border: none; box-shadow: 0 6px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 1000; }
        .period-selector { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .period-selector button { background: none; border: 2px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; font-weight: bold; cursor: pointer; color: var(--primary-color); }
        .period-selector h2 { margin: 0; font-size: 1.2rem; color: var(--primary-color); font-weight: 600; text-transform: capitalize; }
        .summary-cards { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 600px) { .summary-cards { grid-template-columns: repeat(3, 1fr); } }
        .card { background-color: var(--card-bg); padding: 1.2rem; border-radius: 8px; box-shadow: var(--shadow); border-left: 5px solid; }
        .card h3 { margin-top: 0; font-size: 1rem; color: #6c757d; }
        .card p { margin: 0; font-size: 1.75rem; font-weight: bold; }
        .card.revenue p { color: var(--revenue-color); } .card.revenue { border-color: var(--revenue-color); }
        .card.expenses p { color: var(--expenses-color); } .card.expenses { border-color: var(--expenses-color); }
        .card.balance p { color: var(--balance-color); } .card.balance { border-color: var(--balance-color); }
        #transaction-list { margin-top: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .transaction-item { display: flex; align-items: center; background-color: var(--card-bg); padding: 1rem; border-radius: 8px; box-shadow: var(--shadow); border-left: 5px solid; }
        .transaction-item .icon { font-size: 1.5rem; margin-right: 1rem; }
        .transaction-item .details { flex-grow: 1; } .transaction-item .details p { margin: 0; }
        .transaction-item .details .description { font-weight: 600; }
        .transaction-item .details .meta { font-size: 0.8rem; color: #6c757d; margin-top: 4px; }
        .transaction-item .amount { font-weight: bold; font-size: 1.1rem; margin-left: 1rem; }
        .transaction-actions { display: flex; gap: 0.5rem; } .transaction-actions button { background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #6c757d; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); max-height: 90vh; display: flex; flex-direction: column; }
        .modal-body { overflow-y: auto; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="auth-form-container">
            <form id="login-form">
                <h2>Login</h2>
                <div id="login-error" class="auth-error hidden"></div>
                <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div>
                <div class="form-group"><label for="login-password">Senha</label><input type="password" id="login-password" required></div>
                <button type="submit">Entrar</button>
                <p class="toggle-auth">NÃ£o tem uma conta? <a id="show-register">Cadastre-se</a></p>
            </form>
            <form id="register-form" class="hidden">
                <h2>Cadastro</h2>
                <div id="register-error" class="auth-error hidden"></div>
                <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div>
                <div class="form-group"><label for="register-password">Senha (mÃ­nimo 6 caracteres)</label><input type="password" id="register-password" required></div>
                <button type="submit">Cadastrar</button>
                <p class="toggle-auth">JÃ¡ tem uma conta? <a id="show-login">FaÃ§a Login</a></p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <header>
            <button id="logout-btn" class="header-btn" title="Sair">ðŸšª</button>
            <h1>Meu Controle Financeiro</h1>
            <button id="wallets-btn" class="header-btn" title="Gerenciar Carteiras">ðŸ’¼</button>
        </header>

        <main>
            <section id="dashboard">
                <div class="period-selector"><button id="prev-month-btn">&lt;</button><h2 id="current-month-display"></h2><button id="next-month-btn">&gt;</button></div>
                <div class="summary-cards"><div class="card revenue"><h3>Receita do MÃªs</h3><p id="total-revenue">R$ 0,00</p></div><div class="card expenses"><h3>Despesa do MÃªs</h3><p id="total-expenses">R$ 0,00</p></div><div class="card balance"><h3>BalanÃ§o</h3><p id="balance">R$ 0,00</p></div></div>
            </section>
            <section id="transactions"><h2>LanÃ§amentos</h2><div id="transaction-list"></div></section>
        </main>

        <button id="add-transaction-btn" class="fab">+</button>
        
        <footer><span id="user-email-display" title="UsuÃ¡rio Logado"></span></footer>
    </div>

    <!-- Modals -->
    <div id="transaction-modal" class="modal-overlay"> <!-- ... (conteÃºdo dos modais igual Ã  v6) ... --> </div>
    <div id="wallets-modal" class="modal-overlay"> <!-- ... (conteÃºdo dos modais igual Ã  v6) ... --> </div>
    <div id="confirm-delete-modal" class="modal-overlay"> <!-- ... (conteÃºdo dos modais igual Ã  v6) ... --> </div>
    <div id="alert-modal" class="modal-overlay"> <!-- ... (conteÃºdo dos modais igual Ã  v6) ... --> </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÃ‡ÃƒO ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM ELEMENTS ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailDisplay = document.getElementById('user-email-display');
        // ... (resto dos elementos do DOM do app)

        // --- APP STATE ---
        let currentUser = null;
        let wallets = [];
        let transactions = [];
        let currentDate = new Date();
        let walletsUnsubscribe = null;
        let transactionsUnsubscribe = null;

        // --- AUTH LOGIC ---
        showRegisterBtn.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        });
        showLoginBtn.addEventListener('click', () => {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = registerForm['register-email'].value;
            const password = registerForm['register-password'].value;
            const errorDiv = document.getElementById('register-error');
            errorDiv.classList.add('hidden');
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorDiv.textContent = "Erro: " + error.message;
                errorDiv.classList.remove('hidden');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            const errorDiv = document.getElementById('login-error');
            errorDiv.classList.add('hidden');
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorDiv.textContent = "Email ou senha invÃ¡lidos.";
                errorDiv.classList.remove('hidden');
            }
        });
        
        logoutBtn.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                userEmailDisplay.textContent = user.email;
                setupFirestoreListeners(user.uid);
            } else {
                currentUser = null;
                appContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                if (walletsUnsubscribe) walletsUnsubscribe();
                if (transactionsUnsubscribe) transactionsUnsubscribe();
            }
        });

        // --- FIRESTORE & APP LOGIC ---
        // (Aqui entra toda a lÃ³gica do app: render, modals, CRUD, etc.)
        
        function setupFirestoreListeners(userId) {
            const walletsRef = collection(db, 'artifacts', appId, 'users', userId, 'wallets');
            const transactionsRef = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
            
            walletsUnsubscribe = onSnapshot(walletsRef, (snapshot) => {
                wallets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (snapshot.docs.length === 0 && !snapshot.metadata.hasPendingWrites) {
                    addDoc(walletsRef, { name: "Carteira Principal" });
                }
                renderApp();
            });

            transactionsUnsubscribe = onSnapshot(transactionsRef, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp();
            });
        }
        
        function renderApp(){
            // FunÃ§Ã£o central para chamar todas as renderizaÃ§Ãµes
            if(!document.getElementById('app-container').classList.contains('hidden')){
                renderSummary();
                // ... outras renderizaÃ§Ãµes
            }
        }

        function renderSummary() {
            // (implementaÃ§Ã£o completa da renderizaÃ§Ã£o do resumo)
            document.getElementById('current-month-display').textContent = currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
             const filtered = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const adjustedDate = new Date(transactionDate.valueOf() + transactionDate.getTimezoneOffset() * 60 * 1000);
                return adjustedDate.getMonth() === currentDate.getMonth() && adjustedDate.getFullYear() === currentDate.getFullYear();
            });

            const totalRevenue = filtered.reduce((acc, t) => t.type === 'revenue' ? acc + t.amount : acc, 0);
            const totalExpenses = filtered.reduce((acc, t) => t.type === 'expense' ? acc + t.amount : acc, 0);
            const balance = totalRevenue - totalExpenses;

            document.getElementById('total-revenue').textContent = (totalRevenue).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('total-expenses').textContent = (totalExpenses).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('balance').textContent = (balance).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        // Adicionar o resto das funÃ§Ãµes de renderizaÃ§Ã£o e manipuladores de eventos aqui.
        document.getElementById('prev-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderApp(); });
        document.getElementById('next-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderApp(); });

    </script>
</body>
</html>
